<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Sparkminds</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #6a82fb, #fc5c7d);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-attachment: fixed;
        }

        #admin-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            text-align: center;
            width: 100%;
            max-width: 700px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeIn 1s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-weight: 700;
            font-size: 2.8rem;
            margin-bottom: 30px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        #login-section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="text"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-group input[type="email"]::placeholder,
        .form-group input[type="password"]::placeholder,
        .form-group input[type="text"]::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-group input[type="email"]:focus,
        .form-group input[type="password"]:focus,
        .form-group input[type="text"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .auth-button,
        .action-button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin: 10px 5px;
        }

        .auth-button:hover,
        .action-button:hover {
            background: #fff;
            color: #6a82fb;
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(106, 130, 251, 0.5);
        }

        #upload-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            /* Hidden by default */
        }

        #upload-section h2 {
            font-weight: 600;
            font-size: 2rem;
            margin-bottom: 25px;
            color: #fff;
        }

        #file-upload-status {
            margin-top: 15px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            min-height: 20px;
        }

        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: #fff;
            font-size: 1.5rem;
        }

        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid #fc5c7d;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #upload-progress {
            margin-top: 10px;
            font-size: 1.2rem;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            #admin-container {
                padding: 30px 20px;
            }

            h1 {
                font-size: 2.2rem;
                margin-bottom: 20px;
            }

            #upload-section h2 {
                font-size: 1.7rem;
                margin-bottom: 20px;
            }

            .auth-button,
            .action-button {
                padding: 12px 25px;
                font-size: 1rem;
                margin: 8px 3px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px 12px;
                font-size: 0.95rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            #admin-container {
                padding: 25px 15px;
            }

            h1 {
                font-size: 1.8rem;
            }

            #upload-section h2 {
                font-size: 1.5rem;
            }

            .auth-button,
            .action-button {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .form-group label {
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>Uploading...</p>
        <p id="upload-progress">0%</p>
    </div>

    <div id="admin-container">
        <h1>Admin Panel</h1>

        <div id="login-section">
            <h2>Login</h2>
            <div class="form-group">
                <label for="adminEmail">Email:</label>
                <input type="email" id="adminEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="adminPassword">Password:</label>
                <input type="password" id="adminPassword" placeholder="Enter your password">
            </div>
            <button class="auth-button" onclick="loginAdmin()">Login</button>
            <button class="auth-button" onclick="logoutAdmin()" style="display:none;" id="logoutButton">Logout</button>
        </div>

        <div id="upload-section">
            <h2>Upload New Note</h2>
            <div class="form-group">
                <label for="noteSubject">Subject:</label>
                <select id="noteSubject">
                    </select>
            </div>
            <div class="form-group">
                <label for="noteGrade">Grade:</label>
                <select id="noteGrade">
                    <option value="Grade 1">Grade 1</option>
                    <option value="Grade 2">Grade 2</option>
                    <option value="Grade 3">Grade 3</option>
                    <option value="Grade 4">Grade 4</option>
                    <option value="Grade 5">Grade 5</option>
                    <option value="Grade 6">Grade 6</option>
                    <option value="Grade 7">Grade 7</option>
                    <option value="Grade 8">Grade 8</option>
                    <option value="Form 1">Form 1</option>
                    <option value="Form 2">Form 2</option>
                    <option value="Form 3">Form 3</option>
                    <option value="Form 4">Form 4</option>
                    <option value="Form 5">Form 5</option>
                    <option value="Form 6">Form 6</option>
                </select>
            </div>
            <div class="form-group">
                <label for="noteTitle">Title:</label>
                <input type="text" id="noteTitle" placeholder="e.g., Introduction to Algebra">
            </div>
            <div class="form-group">
                <label for="noteTopic">Topic:</label>
                <input type="text" id="noteTopic" placeholder="e.g., Equations, Photosynthesis, World War I">
            </div>
            <div class="form-group">
                <label for="noteContent">Content:</label>
                <textarea id="noteContent" rows="8" placeholder="Type your note content here..."></textarea>
            </div>
            <div class="form-group">
                <label for="noteFile">Attach File (PDF/Image):</label>
                <input type="file" id="noteFile" accept=".pdf,image/*">
                <div id="file-upload-status"></div>
            </div>
            <button class="action-button" onclick="uploadNote()">Upload Note</button>
        </div>
    </div>

    <script>
        // Firebase Configuration (from your provided files)
        const firebaseConfig = {
            apiKey: "AIzaSyABCpgwLNKvUxdYtnz5HBHH9IlnDZgEbUo",
            authDomain: "creative-learning-f2252.firebaseapp.com",
            projectId: "creative-learning-f2252",
            storageBucket: "creative-learning-f2252.appspot.com",
            messagingSenderId: "451756350336",
            appId: "1:451756350336:web:19b9255b8834a01f4cff65"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Supabase Configuration (from your provided files - replace with your actual key)
        const SUPABASE_URL = 'https://jjqbpiujwmlfgztpinyp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Ensure this is your actual public key
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


        // UI Elements
        const loginSection = document.getElementById('login-section');
        const uploadSection = document.getElementById('upload-section');
        const logoutButton = document.getElementById('logoutButton');
        const adminEmailInput = document.getElementById('adminEmail');
        const adminPasswordInput = document.getElementById('adminPassword');
        const noteSubjectSelect = document.getElementById('noteSubject');
        const noteGradeSelect = document.getElementById('noteGrade');
        const noteTitleInput = document.getElementById('noteTitle');
        const noteTopicInput = document.getElementById('noteTopic'); // New: Get topic input
        const noteContentTextarea = document.getElementById('noteContent');
        const noteFileInput = document.getElementById('noteFile');
        const fileUploadStatus = document.getElementById('file-upload-status');
        const loadingOverlay = document.getElementById('loading-overlay');
        const uploadProgress = document.getElementById('upload-progress');


        // --- Authentication Logic ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                loginSection.style.display = 'none';
                uploadSection.style.display = 'block';
                logoutButton.style.display = 'inline-block';
                loadSubjects(); // Load subjects when logged in
            } else {
                // User is signed out
                loginSection.style.display = 'block';
                uploadSection.style.display = 'none';
                logoutButton.style.display = 'none';
                clearForm(); // Clear form when logged out
            }
        });

        function loginAdmin() {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;

            if (!email || !password) {
                alert('Please enter both email and password.');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    alert('Logged in successfully!');
                    // UI handled by onAuthStateChanged
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    alert(`Login failed: ${errorMessage}`);
                    console.error("Login Error:", errorCode, errorMessage);
                });
        }

        function logoutAdmin() {
            auth.signOut().then(() => {
                alert('Logged out successfully!');
                // UI handled by onAuthStateChanged
            }).catch((error) => {
                console.error("Logout Error:", error);
                alert('Error logging out.');
            });
        }

        // --- Subject Loading Logic ---
        async function loadSubjects() {
            noteSubjectSelect.innerHTML = '<option value="">Loading subjects...</option>';
            try {
                // Try fetching from Firestore first
                const firestoreSnapshot = await db.collection('subjects').orderBy('name').get();
                if (!firestoreSnapshot.empty) {
                    populateSubjectSelect(firestoreSnapshot.docs.map(doc => doc.data()));
                } else {
                    // Fallback to Supabase if Firestore is empty or fails
                    console.warn("Firestore subjects empty, trying Supabase.");
                    await loadSubjectsFromSupabase();
                }
            } catch (firestoreError) {
                console.error("Error loading subjects from Firestore:", firestoreError);
                // Fallback to Supabase on Firestore error
                await loadSubjectsFromSupabase();
            }
        }

        async function loadSubjectsFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('subjects')
                    .select('name');

                if (error) {
                    throw error;
                }
                populateSubjectSelect(data.map(item => ({ name: item.name })));
            } catch (supabaseError) {
                console.error("Error loading subjects from Supabase:", supabaseError);
                noteSubjectSelect.innerHTML = '<option value="">Error loading subjects</option>';
                alert('Failed to load subjects. Please check console for details.');
            }
        }


        function populateSubjectSelect(subjects) {
            noteSubjectSelect.innerHTML = '<option value="">Select a Subject</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.name.toLowerCase().replace(/\s+/g, '-'); // slugify name
                option.textContent = subject.name;
                noteSubjectSelect.appendChild(option);
            });
        }

        // --- Note Upload Logic ---
        async function uploadNote() {
            const subject = noteSubjectSelect.value;
            const grade = noteGradeSelect.value;
            const title = noteTitleInput.value.trim();
            const topic = noteTopicInput.value.trim(); // NEW: Get topic value
            const content = noteContentTextarea.value.trim();
            const file = noteFileInput.files[0];

            if (!subject || !grade || !title || !topic || !content) { // NEW: Validate topic
                alert('Please fill in all required fields (Subject, Grade, Title, Topic, Content).');
                return;
            }

            showLoadingOverlay(true);
            fileUploadStatus.textContent = 'Uploading note...';

            let fileUrl = null;
            let fileType = null;

            try {
                if (file) {
                    fileUploadStatus.textContent = 'Uploading file...';
                    const storageRef = storage.ref(`notes_files/${file.name}`);
                    const uploadTask = storageRef.put(file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            uploadProgress.textContent = `${progress.toFixed(0)}%`;
                        },
                        (error) => {
                            console.error("File upload error:", error);
                            throw new Error("Failed to upload file to Firebase Storage.");
                        },
                        async () => {
                            fileUrl = await storageRef.getDownloadURL();
                            fileType = file.type;
                            fileUploadStatus.textContent = 'File uploaded successfully!';
                            await saveNoteToFirestore(subject, grade, title, topic, content, fileUrl, fileType); // NEW: Pass topic
                        }
                    );
                } else {
                    await saveNoteToFirestore(subject, grade, title, topic, content, null, null); // NEW: Pass topic
                }
            } catch (error) {
                console.error("Upload error:", error);
                alert(`Error uploading note: ${error.message}`);
                fileUploadStatus.textContent = `Upload failed: ${error.message}`;
                showLoadingOverlay(false);
            }
        }

        async function saveNoteToFirestore(subject, grade, title, topic, content, fileUrl, fileType) { // NEW: Receive topic
            try {
                const noteData = {
                    subject: subject,
                    grade: grade,
                    title: title,
                    topic: topic, // NEW: Save topic to Firestore
                    content: content,
                    fileUrl: fileUrl,
                    fileType: fileType,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('notes').add(noteData);
                alert('Note uploaded successfully!');
                clearForm();
            } catch (error) {
                console.error("Error saving note to Firestore:", error);
                throw new Error("Failed to save note details to database.");
            } finally {
                showLoadingOverlay(false);
            }
        }


        function clearForm() {
            noteSubjectSelect.value = '';
            noteGradeSelect.value = 'Grade 1'; // Reset to default
            noteTitleInput.value = '';
            noteTopicInput.value = ''; // NEW: Clear topic input
            noteContentTextarea.value = '';
            noteFileInput.value = ''; // Clear file input
            fileUploadStatus.textContent = '';
            uploadProgress.textContent = '0%';
        }

        function showLoadingOverlay(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }
    </script>
</body>

</html>
