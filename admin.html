<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Smart Mind</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Global Resets */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Body Styling - Consistent Background and Layout */
        body {
            font-family: 'Poppins', sans-serif;
            /* A darker, subtle blue gradient for the background */
            background: linear-gradient(135deg, #1A2980, #26D0CE);
            color: #ecf0f1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Admin Container - Glassmorphism Effect */
        #admin-container {
            background: rgba(255, 255, 255, 0.1);
            /* Slightly transparent white background */
            backdrop-filter: blur(10px);
            /* Blur effect for glassmorphism */
            -webkit-backdrop-filter: blur(10px);
            /* Safari support */
            border-radius: 15px;
            /* Rounded corners */
            padding: 30px;
            /* Inner spacing */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            /* Subtle shadow for depth */
            border: 1px solid rgba(255, 255, 255, 0.18);
            /* Light border */
            width: 100%;
            max-width: 600px;
            /* Max width for content */
            text-align: center;
            /* Center text elements */
            animation: fadeIn 0.8s ease-out forwards;
        }

        /* Fade-in Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Headings */
        h1,
        h2 {
            color: #fff;
            margin-bottom: 25px;
            font-weight: 600;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 2.5em;
        }

        h2 {
            font-size: 1.8em;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Form Group Styling */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #e0e0e0;
        }

        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="text"],
        .form-group select,
        .form-group textarea,
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .form-group input[type="email"]::placeholder,
        .form-group input[type="password"]::placeholder,
        .form-group input[type="text"]::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .form-group input[type="email"]:focus,
        .form-group input[type="password"]:focus,
        .form-group input[type="text"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2), inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* Specific style for file input for better visual consistency */
        .form-group input[type="file"] {
            padding-top: 10px;
            /* Adjust padding for file input */
        }

        /* Button Styling */
        .auth-button,
        .action-button {
            background: linear-gradient(90deg, #6a82fb, #26d0ce);
            color: #fff;
            padding: 12px 25px;
            border: none;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin: 5px;
        }

        .auth-button:hover,
        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(90deg, #26d0ce, #6a82fb);
        }

        /* Upload Section - Initially Hidden */
        #upload-section {
            display: none;
            /* JavaScript will toggle this */
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* File Upload Status */
        #file-upload-status {
            margin-top: 10px;
            font-size: 0.9em;
            color: #c0c0c0;
            min-height: 20px;
        }

        /* Loading Overlay */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: #fff;
            font-size: 1.5rem;
        }

        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid #26D0CE;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #upload-progress {
            margin-top: 10px;
            font-size: 1.2rem;
            font-weight: 600;
        }


        /* Custom Alert Message Styling */
        .custom-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 500;
            z-index: 1001;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.5s ease-out forwards, fadeOut 0.5s ease-out 4.5s forwards;
            min-width: 250px;
            text-align: center;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            #admin-container {
                padding: 25px;
            }

            h1 {
                font-size: 2.2em;
            }

            h2 {
                font-size: 1.6em;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 10px;
                font-size: 0.95rem;
            }

            .auth-button,
            .action-button {
                padding: 10px 20px;
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            #admin-container {
                padding: 20px 15px;
            }

            h1 {
                font-size: 2em;
            }

            h2 {
                font-size: 1.4em;
            }

            .custom-message {
                padding: 12px 20px;
                font-size: 1em;
                width: 90%;
            }
        }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>Uploading...</p>
        <p id="upload-progress">0%</p>
    </div>

    <div id="admin-container">
        <h1>Admin Panel</h1>

        <div id="login-section">
            <h2>Login</h2>
            <div class="form-group">
                <label for="adminEmail">Email:</label>
                <input type="email" id="adminEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="adminPassword">Password:</label>
                <input type="password" id="adminPassword" placeholder="Enter your password">
            </div>
            <button class="auth-button" onclick="loginAdmin()">Login</button>
            <button class="auth-button" onclick="logoutAdmin()" style="display:none;" id="logoutButton">Logout</button>
        </div>

        <div id="upload-section">
            <h2>Upload New Note</h2>
            <div class="form-group">
                <label for="noteSubject">Subject:</label>
                <select id="noteSubject">
                    </select>
            </div>
            <div class="form-group">
                <label for="noteGrade">Grade:</label>
                <select id="noteGrade">
                    <option value="Grade 1">Grade 1</option>
                    <option value="Grade 2">Grade 2</option>
                    <option value="Grade 3">Grade 3</option>
                    <option value="Grade 4">Grade 4</option>
                    <option value="Grade 5">Grade 5</option>
                    <option value="Grade 6">Grade 6</option>
                    <option value="Grade 7">Grade 7</option>
                    <option value="Grade 8">Grade 8</option>
                    <option value="Form 1">Form 1</option>
                    <option value="Form 2">Form 2</option>
                    <option value="Form 3">Form 3</option>
                    <option value="Form 4">Form 4</option>
                    <option value="Form 5">Form 5</option>
                    <option value="Form 6">Form 6</option>
                </select>
            </div>
            <div class="form-group">
                <label for="noteTitle">Title:</label>
                <input type="text" id="noteTitle" placeholder="e.g., Introduction to Algebra">
            </div>
            <div class="form-group">
                <label for="noteTopic">Topic:</label>
                <input type="text" id="noteTopic" placeholder="e.g., Equations, Photosynthesis, World War I">
            </div>
            <div class="form-group">
                <label for="noteContent">Content:</label>
                <textarea id="noteContent" rows="8" placeholder="Type your note content here..."></textarea>
            </div>
            <div class="form-group">
                <label for="noteFile">Attach File (PDF/Image):</label>
                <input type="file" id="noteFile" accept=".pdf,image/*">
                <div id="file-upload-status"></div>
            </div>
            <button class="action-button" onclick="uploadNote()">Upload Note</button>
        </div>
    </div>

    <script>
        // Firebase Configuration (from your provided files)
        const firebaseConfig = {
            apiKey: "AIzaSyABCpgwLNKvUxdYtnz5HBHH9IlnDZgEbUo",
            authDomain: "creative-learning-f2252.firebaseapp.com",
            projectId: "creative-learning-f2252",
            storageBucket: "creative-learning-f2252.appspot.com",
            messagingSenderId: "451756350336",
            appId: "1:451756350336:web:19b9255b8834a01f4cff65"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Supabase Configuration (from your provided files - replace with your actual key)
        const SUPABASE_URL = 'https://jjqbpiujwmlfgztpinyp.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Ensure this is your actual public key
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


        // UI Elements
        const loginSection = document.getElementById('login-section');
        const uploadSection = document.getElementById('upload-section');
        const logoutButton = document.getElementById('logoutButton');
        const adminEmailInput = document.getElementById('adminEmail');
        const adminPasswordInput = document.getElementById('adminPassword');
        const noteSubjectSelect = document.getElementById('noteSubject');
        const noteGradeSelect = document.getElementById('noteGrade');
        const noteTitleInput = document.getElementById('noteTitle');
        const noteTopicInput = document.getElementById('noteTopic'); // New: Get topic input
        const noteContentTextarea = document.getElementById('noteContent');
        const noteFileInput = document.getElementById('noteFile');
        const fileUploadStatus = document.getElementById('file-upload-status');
        const loadingOverlay = document.getElementById('loading-overlay');
        const uploadProgress = document.getElementById('upload-progress');


        // --- Authentication Logic ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                loginSection.style.display = 'none';
                uploadSection.style.display = 'block';
                logoutButton.style.display = 'inline-block';
                loadSubjects(); // Load subjects when logged in
            } else {
                // User is signed out
                loginSection.style.display = 'block';
                uploadSection.style.display = 'none';
                logoutButton.style.display = 'none';
                clearForm(); // Clear form when logged out
            }
        });

        function loginAdmin() {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;

            if (!email || !password) {
                alert('Please enter both email and password.');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    showCustomMessage('Logged in successfully!', 'success');
                    // UI handled by onAuthStateChanged
                })
                .catch((error) => {
                    const errorMessage = error.message;
                    showCustomMessage(`Login failed: ${errorMessage}`, 'error');
                    console.error("Login Error:", error);
                });
        }

        function logoutAdmin() {
            auth.signOut().then(() => {
                showCustomMessage('Logged out successfully!', 'success');
                // UI handled by onAuthStateChanged
            }).catch((error) => {
                console.error("Logout Error:", error);
                showCustomMessage('Error logging out.', 'error');
            });
        }

        // --- Subject Loading Logic ---
        async function loadSubjects() {
            noteSubjectSelect.innerHTML = '<option value="">Loading subjects...</option>';
            try {
                // Try fetching from Firestore first
                const firestoreSnapshot = await db.collection('subjects').orderBy('name').get();
                if (!firestoreSnapshot.empty) {
                    populateSubjectSelect(firestoreSnapshot.docs.map(doc => doc.data()));
                } else {
                    // Fallback to Supabase if Firestore is empty or fails
                    console.warn("Firestore subjects empty or failed, trying Supabase.");
                    await loadSubjectsFromSupabase();
                }
            } catch (firestoreError) {
                console.error("Error loading subjects from Firestore:", firestoreError);
                // Fallback to Supabase on Firestore error
                await loadSubjectsFromSupabase();
            }
        }

        async function loadSubjectsFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('subjects')
                    .select('name');

                if (error) {
                    throw error;
                }
                populateSubjectSelect(data.map(item => ({ name: item.name })));
            } catch (supabaseError) {
                console.error("Error loading subjects from Supabase:", supabaseError);
                noteSubjectSelect.innerHTML = '<option value="">Error loading subjects</option>';
                showCustomMessage('Failed to load subjects. Please check console for details.', 'error');
            }
        }

        function populateSubjectSelect(subjects) {
            noteSubjectSelect.innerHTML = '<option value="">Select a Subject</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.name.toLowerCase().replace(/\s+/g, '-'); // slugify name
                option.textContent = subject.name;
                noteSubjectSelect.appendChild(option);
            });
        }

        // --- Note Upload Logic ---
        async function uploadNote() {
            const subject = noteSubjectSelect.value;
            const grade = noteGradeSelect.value;
            const title = noteTitleInput.value.trim();
            const topic = noteTopicInput.value.trim(); // NEW: Get topic value
            const content = noteContentTextarea.value.trim();
            const file = noteFileInput.files[0];

            if (!subject || !grade || !title || !topic || !content) { // NEW: Validate topic
                showCustomMessage('Please fill in all required fields (Subject, Grade, Title, Topic, Content).', 'error');
                return;
            }

            showLoadingOverlay(true);
            fileUploadStatus.textContent = 'Uploading note...';

            let fileUrl = null;
            let fileType = null;

            try {
                if (file) {
                    fileUploadStatus.textContent = 'Uploading file...';
                    const storageRef = storage.ref(`notes_files/${file.name}`);
                    const uploadTask = storageRef.put(file);

                    // Using a promise-based approach for upload task completion
                    await new Promise((resolve, reject) => {
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                uploadProgress.textContent = `${progress.toFixed(0)}%`;
                            },
                            (error) => {
                                reject(error); // Reject the promise on error
                            },
                            async () => {
                                fileUrl = await storageRef.getDownloadURL();
                                fileType = file.type;
                                fileUploadStatus.textContent = 'File uploaded successfully!';
                                resolve(); // Resolve the promise on successful upload
                            }
                        );
                    });
                }
                // Continue to save note after file upload (or if no file)
                await saveNoteToFirestore(subject, grade, title, topic, content, fileUrl, fileType); // NEW: Pass topic
                showCustomMessage('Note uploaded successfully!', 'success');
                clearForm();
            } catch (error) {
                console.error("Upload error:", error);
                showCustomMessage(`Error uploading note: ${error.message}`, 'error');
                fileUploadStatus.textContent = `Upload failed: ${error.message}`;
            } finally {
                showLoadingOverlay(false);
            }
        }

        async function saveNoteToFirestore(subject, grade, title, topic, content, fileUrl, fileType) { // NEW: Receive topic
            try {
                const noteData = {
                    subject: subject,
                    grade: grade,
                    title: title,
                    topic: topic, // NEW: Save topic to Firestore
                    content: content,
                    fileUrl: fileUrl,
                    fileType: fileType,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('notes').add(noteData);
            } catch (error) {
                console.error("Error saving note to Firestore:", error);
                throw new Error("Failed to save note details to database.");
            }
        }

        function clearForm() {
            noteSubjectSelect.value = '';
            noteGradeSelect.value = 'Grade 1'; // Reset to default
            noteTitleInput.value = '';
            noteTopicInput.value = ''; // NEW: Clear topic input
            noteContentTextarea.value = '';
            noteFileInput.value = ''; // Clear file input
            fileUploadStatus.textContent = '';
            uploadProgress.textContent = '0%';
        }

        function showLoadingOverlay(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // Custom Message Display Function
        function showCustomMessage(message, type = 'info') {
            const existingMessage = document.querySelector('.custom-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageContainer = document.createElement('div');
            messageContainer.className = 'custom-message';
            messageContainer.textContent = message;

            if (type === 'success') {
                messageContainer.style.backgroundColor = '#4CAF50'; /* Green */
                messageContainer.style.color = '#fff';
            } else if (type === 'error') {
                messageContainer.style.backgroundColor = '#F44336'; /* Red */
                messageContainer.style.color = '#fff';
            } else {
                messageContainer.style.backgroundColor = '#2196F3'; /* Blue */
                messageContainer.style.color = '#fff';
            }

            document.body.appendChild(messageContainer);

            // Remove the message after a few seconds
            setTimeout(() => {
                messageContainer.remove();
            }, 5000); // Message visible for 5 seconds
        }

        // Keyframes for custom message (ensure these are present or added)
        const styleSheet = document.styleSheets[0];

        // Check if rules exist before inserting to avoid errors on re-run
        const slideInRuleExists = Array.from(styleSheet.cssRules).some(rule => rule.cssText.includes('@keyframes slideIn'));
        const fadeOutRuleExists = Array.from(styleSheet.cssRules).some(rule => rule.cssText.includes('@keyframes fadeOut'));
        
        if (!slideInRuleExists) {
            styleSheet.insertRule(`
            @keyframes slideIn {
                from { top: 0px; opacity: 0; }
                to { top: 20px; opacity: 1; }
            }
            `, styleSheet.cssRules.length);
        }

        if (!fadeOutRuleExists) {
            styleSheet.insertRule(`
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            `, styleSheet.cssRules.length);
        }
    </script>
</body>

</html>
